# üìò –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

## üîÑ –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

```text
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç (Svelte)
  ‚Üì –≤—ã–∑—ã–≤–∞–µ—Ç
Actions (src/lib/utils/itemsActions.js)
  ‚Üì –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫
API (src/routes/api/[entity]/...)
  ‚Üì –≤—ã–∑—ã–≤–∞–µ—Ç
Services (src/lib/server/utils/[entity]Service.js)
  ‚Üì –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫
–ë–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö (MongoDB)
  ‚Üì –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç
–¥–∞–Ω–Ω—ã–µ ‚Üí mergeWithDefaults() ‚Üí UI
```

---

## üß± –£—Ä–æ–≤–Ω–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

| –£—Ä–æ–≤–µ–Ω—å         | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ                              | –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å                                                                                                |
| --------------- | ----------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| **UI**          | `src/lib/components/admin/`               | –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø–æ–ª—è —Ñ–æ—Ä–º—ã, —Ä–µ–Ω–¥–µ—Ä–∏—Ç –ø–æ —Å—Ö–µ–º–µ (ObjectField, ArrayField, PrimitiveField). –ù–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–æ–≥–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö. |
| **Actions**     | `src/lib/utils/itemsActions.js`           | –í—ã–∑–æ–≤—ã API (fetch), –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Ñ—Ä–æ–Ω—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä. –ú–∏–Ω–∏–º—É–º –ª–æ–≥–∏–∫–∏.                                        |
| **API routes**  | `src/routes/api/[entity]/+server.js`      | –í–∞–ª–∏–¥–∞—Ü–∏—è, —Ä–∞–∑–±–æ—Ä —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞, –≤–æ–∑–≤—Ä–∞—Ç JSON-–æ—Ç–≤–µ—Ç–∞.                                                           |
| **Services**    | `src/lib/server/utils/[entity]Service.js` | –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: create, get, update, delete. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è –∏ —Å–ª–∏—è–Ω–∏–µ —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏.    |
| **Schemas**     | `src/lib/schemas/[entity]Schema.js`       | –û–ø–∏—Å—ã–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è (—á–µ—Ä–µ–∑ Zod).                                                   |
| **Merge Layer** | `src/lib/utils/mergeWithDefaults.js`      | –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–∞–∑—ã —Å–æ —Å—Ö–µ–º–æ–π, –¥–æ–±–∞–≤–ª—è—è –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –∏ –¥–µ—Ñ–æ–ª—Ç—ã.                                    |

---

## ü•â –ü—Ä–∏–º–µ—Ä —Ü–µ–ø–æ—á–∫–∏

### –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (GET)

1. UI –≤—ã–∑—ã–≤–∞–µ—Ç `getItem(slug, 'blogs')` –∏–∑ **itemsActions.js**
2. API `/api/blogs/[slug]` –≤—ã–∑—ã–≤–∞–µ—Ç `getItemFromDB(slug, 'blogs')`
3. `getItemFromDB` –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ MongoDB
4. –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ `mergeWithDefaults(blogSchema, data)`
5. UI –ø–æ–ª—É—á–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ö–µ–º–µ

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (POST/PUT)

1. UI —Å–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
2. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö —á–µ—Ä–µ–∑ action `createItem('blogs', formData)`
3. API –ø—Ä–∏–Ω–∏–º–∞–µ—Ç, –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ `blogSchema.parse()`
4. `createItemInDB` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ MongoDB
5. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –∫–ª–∏–µ–Ω—Ç—É

---

## üóÇÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
 ‚îú‚îÄ‚îÄ lib/
 ‚îÇ   ‚îú‚îÄ‚îÄ components/admin/
 ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ UniversalForm.svelte
 ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ObjectField.svelte
 ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ArrayField.svelte
 ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PrimitiveField.svelte
 ‚îÇ   ‚îú‚îÄ‚îÄ schemas/
 ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ blogSchema.js
 ‚îÇ   ‚îú‚îÄ‚îÄ utils/
 ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ itemsActions.js
 ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mergeWithDefaults.js
 ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ helpers.js
 ‚îÇ   ‚îî‚îÄ‚îÄ server/utils/
 ‚îÇ       ‚îú‚îÄ‚îÄ blogService.js
 ‚îÇ       ‚îî‚îÄ‚îÄ db.js
 ‚îú‚îÄ‚îÄ routes/api/blogs/
 ‚îÇ   ‚îú‚îÄ‚îÄ +server.js
 ‚îÇ   ‚îî‚îÄ‚îÄ [slug]/+server.js
 ‚îî‚îÄ‚îÄ app.html
```

---

## ü•∞ mergeWithDefaults.js

–§–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–æ—Ä–º–∞ **–≤—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –±–∞–∑–µ —á–µ–≥–æ-—Ç–æ –Ω–µ—Ç.

```js
export function mergeWithDefaults(schemaDefaults, dbData = {}) {
  if (Array.isArray(schemaDefaults)) return dbData || [];

  const merged = { ...schemaDefaults };
  for (const key in schemaDefaults) {
    const val = dbData?.[key];
    if (val === undefined || val === null) continue;

    if (Array.isArray(val) && Array.isArray(schemaDefaults[key])) {
      merged[key] = val.map((v, i) => mergeWithDefaults(schemaDefaults[key][0], v));
    } else if (typeof val === 'object' && typeof schemaDefaults[key] === 'object') {
      merged[key] = mergeWithDefaults(schemaDefaults[key], val);
    } else {
      merged[key] = val;
    }
  }
  return merged;
}
```

---

## ü•Æ –ü—Ä–∏–Ω—Ü–∏–ø—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–°—Ö–µ–º–∞ ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã.** –í—Å–µ —Ñ–æ—Ä–º—ã, –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å—Ç—Ä–æ—è—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ö–µ–º—ã.
2. **UI —Ç—É–ø–æ–π.** –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–æ–≥–∏–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äî –æ–Ω–∏ —Ç–æ–ª—å–∫–æ —Ä–µ–Ω–¥–µ—Ä—è—Ç –ø–æ–ª—è, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∏–∑ —Å—Ö–µ–º—ã.
3. **Actions –º–∏–Ω–∏–º–∞–ª—å–Ω—ã.** –í—Å–µ, —á—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö, –¥–æ–ª–∂–Ω–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–ª–∏ –≤ merge-—Ñ—É–Ω–∫—Ü–∏—è—Ö.
4. **–°–ª–∏—è–Ω–∏–µ —Å –¥–µ—Ñ–æ–ª—Ç–∞–º–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.** –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã –æ–Ω–∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –ø–æ —Å—Ö–µ–º–µ –¥–æ –ø–µ—Ä–µ–¥–∞—á–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç.
5. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ.** –î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Redis —Å TTL –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π.
6. **–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è.** –õ–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—è —Ö—Ä–∞–Ω—è—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –≤–º–µ—Å—Ç–µ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ UI.
7. **–û–¥–Ω–æ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫.** –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ API ‚Üí Service ‚Üí Merge ‚Üí UI, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ API ‚Üí Service ‚Üí –ë–∞–∑–∞.

---

–≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–±–æ
